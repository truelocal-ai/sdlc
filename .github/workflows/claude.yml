name: Claude Code

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  issues:
    types: [opened, assigned, edited]
  pull_request_review:
    types: [submitted, edited]

# Ensure only one workflow runs at a time per issue/PR
concurrency:
  group: claude-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Extract Context
        id: context
        env:
          DIFF_HUNK: ${{ github.event.comment.diff_hunk }}
        run: |
          # Initialize variables
          NUMBER=""
          TYPE=""
          BODY=""
          ACTOR=""

          case "${{ github.event_name }}" in
            issues)
              echo "NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=issue" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.issue.number }}"
              TYPE="issue"
              BODY="${{ github.event.issue.body }}"
              ACTOR="${{ github.event.issue.user.login }}"
              ;;
            issue_comment)
              echo "NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=issue" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.issue.number }}"
              TYPE="issue"
              BODY="${{ github.event.comment.body }}"
              ACTOR="${{ github.event.comment.user.login }}"
              ;;
            pull_request_review_comment)
              echo "NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=pr" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.pull_request.number }}"
              TYPE="pr"
              echo "REF=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
              echo "COMMENT_ID=${{ github.event.comment.id }}" >> $GITHUB_OUTPUT
              echo "COMMENT_PATH=${{ github.event.comment.path }}" >> $GITHUB_OUTPUT
              echo "COMMENT_LINE=${{ github.event.comment.line }}" >> $GITHUB_OUTPUT
              {
                echo "COMMENT_DIFF_HUNK<<EOF"
                printf '%s\n' "$DIFF_HUNK" | head -n 5
                echo "EOF"
              } >> $GITHUB_OUTPUT
              BODY="${{ github.event.comment.body }}"
              ACTOR="${{ github.event.comment.user.login }}"
              ;;
            pull_request_review)
              echo "NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=pr" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.pull_request.number }}"
              TYPE="pr"
              echo "REF=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
              BODY="${{ github.event.review.body }}"
              ACTOR="${{ github.event.review.user.login }}"
              ;;
          esac

          echo "ACTOR=$ACTOR" >> $GITHUB_OUTPUT

          # Check if PR branch follows issue-{number} pattern
          # If so, use the issue number for Claude branch but keep PR number for comments
          CLAUDE_NUMBER="${NUMBER}"
          CLAUDE_TYPE="${TYPE}"
          if [ "${{ github.event_name }}" == "pull_request_review_comment" ] || [ "${{ github.event_name }}" == "pull_request_review" ]; then
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            if [[ "$BRANCH_NAME" =~ ^issue-([0-9]+)$ ]]; then
              ISSUE_NUM="${BASH_REMATCH[1]}"
              echo "Detected issue branch pattern: $BRANCH_NAME -> issue #$ISSUE_NUM"
              CLAUDE_NUMBER="$ISSUE_NUM"
              CLAUDE_TYPE="issue"
            fi
          fi

          echo "CLAUDE_NUMBER=$CLAUDE_NUMBER" >> $GITHUB_OUTPUT
          echo "CLAUDE_TYPE=$CLAUDE_TYPE" >> $GITHUB_OUTPUT

          # Detect @override= pattern (case-insensitive, e.g., @override=ollama or @OverRide=zai,glm-4.6)
          OVERRIDE=""
          if echo "$BODY" | grep -qiE "@override=[^[:space:]]+"; then
            # Extract override value (case-insensitive match)
            # Get the match and remove everything up to and including the first "="
            OVERRIDE_MATCH=$(echo "$BODY" | grep -oiE "@override=[^[:space:]]+" | head -1)
            OVERRIDE=$(echo "$OVERRIDE_MATCH" | sed 's/^[^=]*=//')
            echo "Detected override: $OVERRIDE"
          fi

          # Remove @claude mentions and @override patterns from body (case-insensitive)
          BODY=$(echo "$BODY" | sed -E 's/@claude//gi' | sed -E 's/@override=[^[:space:]]*//gi')

          # Multi-line output
          {
            echo "BODY<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Output override if detected
          if [ -n "$OVERRIDE" ]; then
            echo "OVERRIDE=$OVERRIDE" >> $GITHUB_OUTPUT
          fi

      - name: Check User Permissions
        id: permission_check
        run: |
          # Prefer an explicit PAT with repo + workflow scopes if provided; otherwise use the job token
          TOKEN="${{ secrets.GH_PAT }}"
          if [ -z "$TOKEN" ]; then
            TOKEN="${{ github.token }}"
          fi

          # Get the user's permission level using GitHub API
          ACTOR="${{ steps.context.outputs.ACTOR }}"
          REPO="${{ github.repository }}"

          echo "Checking permissions for user: $ACTOR"

          # Query GitHub API for user's permission level
          PERMISSION_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/collaborators/$ACTOR/permission")

          PERMISSION=$(echo "$PERMISSION_RESPONSE" | jq -r '.permission // "none"')

          echo "User $ACTOR has permission level: $PERMISSION"

          # Check if user has write, maintain, or admin permission
          if [[ "$PERMISSION" == "write" || "$PERMISSION" == "maintain" || "$PERMISSION" == "admin" ]]; then
            echo "has_permission=true" >> $GITHUB_OUTPUT
            echo "✅ User $ACTOR has sufficient permissions ($PERMISSION)"
          else
            echo "has_permission=false" >> $GITHUB_OUTPUT
            echo "❌ User $ACTOR does not have sufficient permissions (current: $PERMISSION, required: write or above)"

            TYPE="${{ steps.context.outputs.TYPE }}"
            NUMBER="${{ steps.context.outputs.NUMBER }}"

            COMMENT_BODY="⚠️ **Permission Denied**

            Hi @$ACTOR, you need write access or higher to use the Claude workflow."
            
            if [ "$TYPE" == "issue" ]; then
              gh issue comment "$NUMBER" --body "$COMMENT_BODY"
            else
              gh pr comment "$NUMBER" --body "$COMMENT_BODY"
            fi
          fi

      - name: Load Runner Configuration
        id: config
        run: |
          # Load SDLC runner configuration (injected directly to isolate secret storage issues)
          RUNNER_NAME="${{ runner.name }}"
          
          # Inline configuration - injected from .github/sdlc/runner-config.json
          CONFIG_JSON='{
            "default": {
              "router": {
                "enabled": false,
                "config": {}
              }
            },
            "runners": {
              "utmLino*": {
                "router": {
                  "enabled": true,
                  "config": {
                    "Providers": [
                      {
                        "name": "ollama",
                        "api_base_url": "http://192.168.64.1:11434/v1/chat/completions",
                        "api_key": "",
                        "models": [
                          "qwen2.5-coder:7b",
                          "gpt-oss:20b"
                        ]
                      }
                    ],
                    "Router": {
                      "default": "ollama,qwen2.5-coder:7b",
                      "background": "ollama,gpt-oss:20b",
                      "think": "ollama,qwen2.5-coder:7b"
                    }
                  }
                }
              }
            }
          }'
          
          # Validate JSON
          if ! echo "$CONFIG_JSON" | jq empty > /dev/null 2>&1; then
            echo "❌ Error: Inline config is not valid JSON"
            exit 1
          fi
          
          # Extract default config (with error handling)
          DEFAULT_ROUTER_ENABLED=$(echo "$CONFIG_JSON" | jq -r '.default.router.enabled // false' 2>/dev/null || echo "false")
          DEFAULT_ROUTER_CONFIG=$(echo "$CONFIG_JSON" | jq -c '.default.router.config // {}' 2>/dev/null || echo "{}")
          
          # Initialize with defaults
          ROUTER_ENABLED="$DEFAULT_ROUTER_ENABLED"
          ROUTER_CONFIG="$DEFAULT_ROUTER_CONFIG"
          
          # Check for runner-specific config FIRST (before override validation)
          if echo "$CONFIG_JSON" | jq -e '.runners' > /dev/null 2>&1; then
            echo "Checking for runner-specific config for: $RUNNER_NAME"
            
            # Check each runner pattern
            for pattern in $(echo "$CONFIG_JSON" | jq -r '.runners | keys[]' 2>/dev/null || true); do
              # Skip if pattern is empty
              [ -z "$pattern" ] && continue
              
              # Convert wildcard pattern to regex: * -> .*
              PATTERN_REGEX=$(echo "$pattern" | sed 's/\*/\.\*/g')
              
              # Simple pattern matching (supports * wildcard)
              if [[ "$RUNNER_NAME" == "$pattern" ]] || [[ "$RUNNER_NAME" =~ ^${PATTERN_REGEX}$ ]]; then
                echo "✓ Found matching config for pattern: $pattern"
                
                # Override with runner-specific config
                RUNNER_CONFIG=$(echo "$CONFIG_JSON" | jq -c ".runners[\"$pattern\"]" 2>/dev/null || echo "{}")
                
                if [ -n "$RUNNER_CONFIG" ] && [ "$RUNNER_CONFIG" != "{}" ] && [ "$RUNNER_CONFIG" != "null" ]; then
                  if echo "$RUNNER_CONFIG" | jq -e '.router' > /dev/null 2>&1; then
                    ROUTER_ENABLED=$(echo "$RUNNER_CONFIG" | jq -r '.router.enabled // false' 2>/dev/null || echo "false")
                    ROUTER_CONFIG=$(echo "$RUNNER_CONFIG" | jq -c '.router.config // {}' 2>/dev/null || echo "{}")
                    echo "  Router enabled: $ROUTER_ENABLED"
                  fi
                fi
                
                break
              fi
            done
          fi
          
          MODEL_OVERRIDE=""
          
          # Check for @override in user prompt (after runner config is loaded)
          OVERRIDE="${{ steps.context.outputs.OVERRIDE }}"
          if [ -n "$OVERRIDE" ]; then
            echo "Checking override request: $OVERRIDE"
            
            # Parse override (format: "provider" or "provider,model")
            if echo "$OVERRIDE" | grep -q ","; then
              OVERRIDE_PROVIDER=$(echo "$OVERRIDE" | cut -d',' -f1)
              OVERRIDE_MODEL=$(echo "$OVERRIDE" | cut -d',' -f2)
            else
              OVERRIDE_PROVIDER="$OVERRIDE"
              OVERRIDE_MODEL=""
            fi
            
            # Check if router is enabled (after runner config load)
            if [ "$ROUTER_ENABLED" = "true" ] && [ -n "$ROUTER_CONFIG" ] && [ "$ROUTER_CONFIG" != "{}" ]; then
              # Check if provider exists in router config
              PROVIDER_EXISTS=$(echo "$ROUTER_CONFIG" | jq -e ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\")" > /dev/null 2>&1 && echo "true" || echo "false") || PROVIDER_EXISTS="false"
              
              if [ "$PROVIDER_EXISTS" = "true" ]; then
                if [ -n "$OVERRIDE_MODEL" ]; then
                  # Check if specific model exists
                  MODEL_EXISTS=$(echo "$ROUTER_CONFIG" | jq -e ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\") | .models[] | select(. == \"$OVERRIDE_MODEL\")" > /dev/null 2>&1 && echo "true" || echo "false") || MODEL_EXISTS="false"
                  
                  if [ "$MODEL_EXISTS" = "true" ]; then
                    MODEL_OVERRIDE="$OVERRIDE"
                    echo "✓ Override validated: $MODEL_OVERRIDE is available"
                  else
                    echo "⚠️ Model $OVERRIDE_MODEL not found in provider $OVERRIDE_PROVIDER"
                    echo "  Available models:"
                    echo "$ROUTER_CONFIG" | jq -r ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\") | .models[]" 2>/dev/null | sed 's/^/    - /' || echo "    (unable to list models)"
                    echo "  Falling back to default router configuration"
                  fi
                else
                  # Provider only - use first model from that provider
                  FIRST_MODEL=$(echo "$ROUTER_CONFIG" | jq -r ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\") | .models[0]" 2>/dev/null || echo "")
                  if [ -n "$FIRST_MODEL" ] && [ "$FIRST_MODEL" != "null" ]; then
                    MODEL_OVERRIDE="$OVERRIDE_PROVIDER,$FIRST_MODEL"
                    echo "✓ Override validated: using $MODEL_OVERRIDE (first model from provider)"
                  else
                    echo "⚠️ No models found for provider $OVERRIDE_PROVIDER"
                    echo "  Falling back to default router configuration"
                  fi
                fi
              else
                echo "⚠️ Provider $OVERRIDE_PROVIDER not configured for this runner"
                echo "  Available providers:"
                echo "$ROUTER_CONFIG" | jq -r ".Providers[].name" 2>/dev/null | sed 's/^/    - /' || echo "    (unable to list providers)"
                echo "  Falling back to default router configuration"
              fi
            else
              echo "⚠️ Router not enabled for this runner"
              echo "  Cannot use override $OVERRIDE, falling back to standard Claude"
            fi
          fi
          
          # Output configuration
          echo "router_enabled=$ROUTER_ENABLED" >> $GITHUB_OUTPUT
          
          # Validate ROUTER_CONFIG before outputting
          if [ -n "$ROUTER_CONFIG" ] && [ "$ROUTER_CONFIG" != "{}" ]; then
            if ! echo "$ROUTER_CONFIG" | jq empty > /dev/null 2>&1; then
              echo "⚠️  Warning: ROUTER_CONFIG is not valid JSON, using empty config"
              ROUTER_CONFIG="{}"
            fi
          fi
          
          # Base64 encode ROUTER_CONFIG to preserve JSON structure when passing as env var
          if [ -n "$ROUTER_CONFIG" ] && [ "$ROUTER_CONFIG" != "{}" ]; then
            ROUTER_CONFIG_B64=$(echo -n "$ROUTER_CONFIG" | base64 -w 0)
            echo "router_config_b64=$ROUTER_CONFIG_B64" >> $GITHUB_OUTPUT
          else
            echo "router_config_b64=" >> $GITHUB_OUTPUT
          fi
          echo "model_override=$MODEL_OVERRIDE" >> $GITHUB_OUTPUT
          
          echo "Configuration loaded:"
          echo "  Runner: $RUNNER_NAME"
          echo "  Router Enabled: $ROUTER_ENABLED"
          echo "  Router Config length: $(echo "$ROUTER_CONFIG" | wc -c)"
          if [ -n "$MODEL_OVERRIDE" ]; then
            echo "  Model Override: $MODEL_OVERRIDE"
          fi

      - name: Prepare Router Environment
        if: steps.permission_check.outputs.has_permission == 'true' && steps.config.outputs.router_enabled == 'true'
        run: |
          # Install bun if not available
          if ! command -v bun > /dev/null 2>&1; then
            curl -fsSL https://bun.sh/install | bash
            export PATH="$HOME/.bun/bin:$PATH"
          fi
          
          # Create router config directory
          mkdir -p $HOME/.claude-code-router
          
          # Decode router config if provided
          if [ -n "${{ steps.config.outputs.router_config_b64 }}" ]; then
            echo "${{ steps.config.outputs.router_config_b64 }}" | base64 -d > $HOME/.claude-code-router/config.json
            echo "✓ Router config loaded from base64"
          else
            # Create default config with Ollama
            cat > $HOME/.claude-code-router/config.json << 'EOF'
          {
            "NON_INTERACTIVE_MODE": true,
            "Providers": [
              {
                "name": "ollama",
                "api_base_url": "http://192.168.64.1:11434/v1/chat/completions",
                "api_key": "",
                "models": [
                  "qwen2.5-coder:7b",
                  "gpt-oss:20b"
                ]
              }
            ],
            "Router": {
              "default": "ollama,qwen2.5-coder:7b",
              "background": "ollama,gpt-oss:20b",
              "think": "ollama,qwen2.5-coder:7b"
            }
          }
          EOF
            echo "✓ Default router config created"
          fi
          
          # Apply model override if specified
          if [ -n "${{ steps.config.outputs.model_override }}" ]; then
            jq --arg override "${{ steps.config.outputs.model_override }}" '.Router.default = $override' \
              $HOME/.claude-code-router/config.json > $HOME/.claude-code-router/config.json.tmp
            mv $HOME/.claude-code-router/config.json.tmp $HOME/.claude-code-router/config.json
            echo "✓ Model override applied: ${{ steps.config.outputs.model_override }}"
          fi
          
          # Validate config
          if ! jq empty $HOME/.claude-code-router/config.json 2>/dev/null; then
            echo "❌ Error: Router config is not valid JSON"
            exit 1
          fi
          
          echo "Router config:"
          cat $HOME/.claude-code-router/config.json | jq '.'
        shell: bash

      - name: Start Claude Code Router
        if: steps.permission_check.outputs.has_permission == 'true' && steps.config.outputs.router_enabled == 'true'
        run: |
          export PATH="$HOME/.bun/bin:$PATH"
          nohup bunx @musistudio/claude-code-router@latest start > /tmp/ccr.log 2>&1 &
          sleep 5
          
          # Wait for service to be ready
          for i in {1..20}; do
            if curl -s http://localhost:3456/health > /dev/null 2>&1; then
              echo "✓ Router service started"
              break
            fi
            sleep 1
          done
          
          if ! curl -s http://localhost:3456/health > /dev/null 2>&1; then
            echo "❌ Error: Router service failed to start"
            cat /tmp/ccr.log
            exit 1
          fi
        shell: bash

      - name: Prepare Prompt
        if: steps.permission_check.outputs.has_permission == 'true'
        id: prompt
        run: |
          PROMPT="You are working on ${{ steps.context.outputs.TYPE }} #${{ steps.context.outputs.NUMBER }} in repository ${{ github.repository }}."
          
          # Add PR review comment context if available
          if [ -n "${{ steps.context.outputs.COMMENT_PATH }}" ]; then
            PROMPT="$PROMPT

          This is a PR review comment on:
          - File: ${{ steps.context.outputs.COMMENT_PATH }}
          - Line: ${{ steps.context.outputs.COMMENT_LINE }}
          - Comment ID: ${{ steps.context.outputs.COMMENT_ID }}
          - Code context:
          \`\`\`
          ${{ steps.context.outputs.COMMENT_DIFF_HUNK }}
          \`\`\`"
          fi
          
          PROMPT="$PROMPT

          User request: ${{ steps.context.outputs.BODY }}"
          
          # Output as multiline string
          {
            echo "prompt<<EOF"
            printf '%s\n' "$PROMPT"
            echo "EOF"
          } >> $GITHUB_OUTPUT
        shell: bash

      - name: Set Router URL
        if: steps.permission_check.outputs.has_permission == 'true' && steps.config.outputs.router_enabled == 'true'
        id: router_url
        run: echo "url=http://localhost:3456" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        if: steps.permission_check.outputs.has_permission == 'true'
        id: claude
        uses: anthropics/claude-code-action@beta
        env:
          ANTHROPIC_BASE_URL: ${{ steps.router_url.outputs.url }}
        with:
          anthropic_api_key: "any-string-is-ok"
          prompt: ${{ steps.prompt.outputs.prompt }}
