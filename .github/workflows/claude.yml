name: Claude Code

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  issues:
    types: [opened, assigned, edited]
  pull_request_review:
    types: [submitted, edited]

# Ensure only one workflow runs at a time per issue/PR
concurrency:
  group: claude-${{ github.event_name }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Extract Context
        id: context
        env:
          DIFF_HUNK: ${{ github.event.comment.diff_hunk }}
        run: |
          # Initialize variables
          NUMBER=""
          TYPE=""
          BODY=""
          ACTOR=""

          case "${{ github.event_name }}" in
            issues)
              echo "NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=issue" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.issue.number }}"
              TYPE="issue"
              BODY="${{ github.event.issue.body }}"
              ACTOR="${{ github.event.issue.user.login }}"
              ;;
            issue_comment)
              echo "NUMBER=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=issue" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.issue.number }}"
              TYPE="issue"
              BODY="${{ github.event.comment.body }}"
              ACTOR="${{ github.event.comment.user.login }}"
              ;;
            pull_request_review_comment)
              echo "NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=pr" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.pull_request.number }}"
              TYPE="pr"
              echo "REF=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
              echo "COMMENT_ID=${{ github.event.comment.id }}" >> $GITHUB_OUTPUT
              echo "COMMENT_PATH=${{ github.event.comment.path }}" >> $GITHUB_OUTPUT
              echo "COMMENT_LINE=${{ github.event.comment.line }}" >> $GITHUB_OUTPUT
              {
                echo "COMMENT_DIFF_HUNK<<EOF"
                printf '%s\n' "$DIFF_HUNK" | head -n 5
                echo "EOF"
              } >> $GITHUB_OUTPUT
              BODY="${{ github.event.comment.body }}"
              ACTOR="${{ github.event.comment.user.login }}"
              ;;
            pull_request_review)
              echo "NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              echo "TYPE=pr" >> $GITHUB_OUTPUT
              NUMBER="${{ github.event.pull_request.number }}"
              TYPE="pr"
              echo "REF=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
              BODY="${{ github.event.review.body }}"
              ACTOR="${{ github.event.review.user.login }}"
              ;;
          esac

          echo "ACTOR=$ACTOR" >> $GITHUB_OUTPUT

          # Check if PR branch follows issue-{number} pattern
          # If so, use the issue number for Claude branch but keep PR number for comments
          CLAUDE_NUMBER="${NUMBER}"
          CLAUDE_TYPE="${TYPE}"
          if [ "${{ github.event_name }}" == "pull_request_review_comment" ] || [ "${{ github.event_name }}" == "pull_request_review" ]; then
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            if [[ "$BRANCH_NAME" =~ ^issue-([0-9]+)$ ]]; then
              ISSUE_NUM="${BASH_REMATCH[1]}"
              echo "Detected issue branch pattern: $BRANCH_NAME -> issue #$ISSUE_NUM"
              CLAUDE_NUMBER="$ISSUE_NUM"
              CLAUDE_TYPE="issue"
            fi
          fi

          echo "CLAUDE_NUMBER=$CLAUDE_NUMBER" >> $GITHUB_OUTPUT
          echo "CLAUDE_TYPE=$CLAUDE_TYPE" >> $GITHUB_OUTPUT

          # Detect @override= pattern (e.g., @override=ollama or @override=zai,glm-4.6)
          OVERRIDE=""
          if echo "$BODY" | grep -qE "@override=[^[:space:]]+"; then
            OVERRIDE=$(echo "$BODY" | grep -oE "@override=[^[:space:]]+" | head -1 | sed 's/@override=//')
            echo "Detected override: $OVERRIDE"
          fi

          # Remove @claude mentions and @override patterns from body
          BODY=$(echo "$BODY" | sed 's/@claude//g' | sed 's/@override=[^[:space:]]*//g')

          # Multi-line output
          {
            echo "BODY<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          # Output override if detected
          if [ -n "$OVERRIDE" ]; then
            echo "OVERRIDE=$OVERRIDE" >> $GITHUB_OUTPUT
          fi

      - name: Check User Permissions
        id: permission_check
        run: |
          # Prefer an explicit PAT with repo + workflow scopes if provided; otherwise use the job token
          TOKEN="${{ secrets.GH_PAT }}"
          if [ -z "$TOKEN" ]; then
            TOKEN="${{ github.token }}"
          fi

          # Get the user's permission level using GitHub API
          ACTOR="${{ steps.context.outputs.ACTOR }}"
          REPO="${{ github.repository }}"

          echo "Checking permissions for user: $ACTOR"

          # Query GitHub API for user's permission level
          PERMISSION_RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/collaborators/$ACTOR/permission")

          PERMISSION=$(echo "$PERMISSION_RESPONSE" | jq -r '.permission // "none"')

          echo "User $ACTOR has permission level: $PERMISSION"

          # Check if user has write, maintain, or admin permission
          if [[ "$PERMISSION" == "write" || "$PERMISSION" == "maintain" || "$PERMISSION" == "admin" ]]; then
            echo "has_permission=true" >> $GITHUB_OUTPUT
            echo "✅ User $ACTOR has sufficient permissions ($PERMISSION)"
          else
            echo "has_permission=false" >> $GITHUB_OUTPUT
            echo "❌ User $ACTOR does not have sufficient permissions (current: $PERMISSION, required: write or above)"

            TYPE="${{ steps.context.outputs.TYPE }}"
            NUMBER="${{ steps.context.outputs.NUMBER }}"

            COMMENT_BODY="⚠️ **Permission Denied**

            Hi @$ACTOR, you need write access or higher to use the Claude workflow."
            
            if [ "$TYPE" == "issue" ]; then
              gh issue comment "$NUMBER" --body "$COMMENT_BODY"
            else
              gh pr comment "$NUMBER" --body "$COMMENT_BODY"
            fi
          fi

      - name: Load Runner Configuration
        id: config
        run: |
          # Load SDLC runner configuration from GitHub secret
          # Format: JSON with "default" and "runners" keys
          # Example:
          # {
          #   "default": {
          #     "router": { "enabled": false, "config": {} }
          #   },
          #   "runners": {
          #     "my-runner-*": {
          #       "router": { "enabled": true, "config": {...} }
          #     }
          #   }
          # }
          
          RUNNER_NAME="${{ runner.name }}"
          CONFIG_JSON="${{ secrets.SDLC_RUNNER_CONFIG }}"
          
          # If no config provided, use defaults
          if [ -z "$CONFIG_JSON" ]; then
            echo "No SDLC_RUNNER_CONFIG found, using defaults"
            echo "router_enabled=false" >> $GITHUB_OUTPUT
            echo "router_config=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Validate JSON
          if ! echo "$CONFIG_JSON" | jq empty 2>/dev/null; then
            echo "❌ Error: SDLC_RUNNER_CONFIG is not valid JSON"
            exit 1
          fi
          
          # Extract default config
          DEFAULT_ROUTER_ENABLED=$(echo "$CONFIG_JSON" | jq -r '.default.router.enabled // false')
          DEFAULT_ROUTER_CONFIG=$(echo "$CONFIG_JSON" | jq -c '.default.router.config // {}')
          
          # Initialize with defaults
          ROUTER_ENABLED="$DEFAULT_ROUTER_ENABLED"
          ROUTER_CONFIG="$DEFAULT_ROUTER_CONFIG"
          MODEL_OVERRIDE=""
          
          # Check for @override in user prompt
          OVERRIDE="${{ steps.context.outputs.OVERRIDE }}"
          if [ -n "$OVERRIDE" ]; then
            echo "Checking override request: $OVERRIDE"
            
            # Parse override (format: "provider" or "provider,model")
            if echo "$OVERRIDE" | grep -q ","; then
              OVERRIDE_PROVIDER=$(echo "$OVERRIDE" | cut -d',' -f1)
              OVERRIDE_MODEL=$(echo "$OVERRIDE" | cut -d',' -f2)
            else
              OVERRIDE_PROVIDER="$OVERRIDE"
              OVERRIDE_MODEL=""
            fi
            
            # Check if router is enabled
            if [ "$ROUTER_ENABLED" = "true" ] && [ -n "$ROUTER_CONFIG" ]; then
              # Check if provider exists in router config
              PROVIDER_EXISTS=$(echo "$ROUTER_CONFIG" | jq -e ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\")" > /dev/null 2>&1 && echo "true" || echo "false")
              
              if [ "$PROVIDER_EXISTS" = "true" ]; then
                if [ -n "$OVERRIDE_MODEL" ]; then
                  # Check if specific model exists
                  MODEL_EXISTS=$(echo "$ROUTER_CONFIG" | jq -e ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\") | .models[] | select(. == \"$OVERRIDE_MODEL\")" > /dev/null 2>&1 && echo "true" || echo "false")
                  
                  if [ "$MODEL_EXISTS" = "true" ]; then
                    MODEL_OVERRIDE="$OVERRIDE"
                    echo "✓ Override validated: $MODEL_OVERRIDE is available"
                  else
                    echo "⚠️ Model $OVERRIDE_MODEL not found in provider $OVERRIDE_PROVIDER"
                    echo "  Available models:"
                    echo "$ROUTER_CONFIG" | jq -r ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\") | .models[]" | sed 's/^/    - /'
                    echo "  Falling back to default router configuration"
                  fi
                else
                  # Provider only - use first model from that provider
                  FIRST_MODEL=$(echo "$ROUTER_CONFIG" | jq -r ".Providers[] | select(.name == \"$OVERRIDE_PROVIDER\") | .models[0]")
                  if [ -n "$FIRST_MODEL" ] && [ "$FIRST_MODEL" != "null" ]; then
                    MODEL_OVERRIDE="$OVERRIDE_PROVIDER,$FIRST_MODEL"
                    echo "✓ Override validated: using $MODEL_OVERRIDE (first model from provider)"
                  else
                    echo "⚠️ No models found for provider $OVERRIDE_PROVIDER"
                    echo "  Falling back to default router configuration"
                  fi
                fi
              else
                echo "⚠️ Provider $OVERRIDE_PROVIDER not configured for this runner"
                echo "  Available providers:"
                echo "$ROUTER_CONFIG" | jq -r ".Providers[].name" | sed 's/^/    - /'
                echo "  Falling back to default router configuration"
              fi
            else
              echo "⚠️ Router not enabled for this runner"
              echo "  Cannot use override $OVERRIDE, falling back to standard Claude"
            fi
          fi
          
          # Check for runner-specific config
          if echo "$CONFIG_JSON" | jq -e '.runners' > /dev/null 2>&1; then
            echo "Checking for runner-specific config for: $RUNNER_NAME"
            
            # Check each runner pattern
            for pattern in $(echo "$CONFIG_JSON" | jq -r '.runners | keys[]'); do
              # Convert wildcard pattern to regex: * -> .*
              PATTERN_REGEX=$(echo "$pattern" | sed 's/\*/\.\*/g')
              
              # Simple pattern matching (supports * wildcard)
              if [[ "$RUNNER_NAME" == "$pattern" ]] || [[ "$RUNNER_NAME" =~ ^${PATTERN_REGEX}$ ]]; then
                echo "✓ Found matching config for pattern: $pattern"
                
                # Override with runner-specific config
                RUNNER_CONFIG=$(echo "$CONFIG_JSON" | jq -c ".runners[\"$pattern\"]")
                
                if echo "$RUNNER_CONFIG" | jq -e '.router' > /dev/null 2>&1; then
                  ROUTER_ENABLED=$(echo "$RUNNER_CONFIG" | jq -r '.router.enabled // false')
                  ROUTER_CONFIG=$(echo "$RUNNER_CONFIG" | jq -c '.router.config // {}')
                fi
                
                break
              fi
            done
          fi
          
          # Output configuration
          echo "router_enabled=$ROUTER_ENABLED" >> $GITHUB_OUTPUT
          echo "router_config<<EOF" >> $GITHUB_OUTPUT
          echo "$ROUTER_CONFIG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "model_override=$MODEL_OVERRIDE" >> $GITHUB_OUTPUT
          
          echo "Configuration loaded:"
          echo "  Runner: $RUNNER_NAME"
          echo "  Router Enabled: $ROUTER_ENABLED"
          if [ -n "$MODEL_OVERRIDE" ]; then
            echo "  Model Override: $MODEL_OVERRIDE"
          fi

      - name: Run Claude Code
        if: steps.permission_check.outputs.has_permission == 'true'
        run: |
          # Prefer an explicit PAT with repo + workflow scopes if provided; otherwise use the job token
          TOKEN="${{ secrets.GH_PAT }}"
          if [ -z "$TOKEN" ]; then
            TOKEN="${{ github.token }}"
          fi

          USER_PROMPT="You are working on ${{ steps.context.outputs.TYPE }} #${{ steps.context.outputs.NUMBER }} in repository ${{ github.repository }}."

          # Add PR review comment context if available
          if [ -n "${{ steps.context.outputs.COMMENT_PATH }}" ]; then
            USER_PROMPT="$USER_PROMPT

          This is a PR review comment on:
          - File: ${{ steps.context.outputs.COMMENT_PATH }}
          - Line: ${{ steps.context.outputs.COMMENT_LINE }}
          - Comment ID: ${{ steps.context.outputs.COMMENT_ID }}
          - Code context:
          \`\`\`
          ${{ steps.context.outputs.COMMENT_DIFF_HUNK }}
          \`\`\`"
          fi

          USER_PROMPT="$USER_PROMPT

          User request: ${{ steps.context.outputs.BODY }}"

          # Note: This workflow runs via DinD (Docker-in-Docker)
          # The certs are already available at /certs/client in the DinD container's filesystem
          # We use bind mounts instead of volume mounts since DinD has its own volume namespace

          # Get the DinD container's IP from the host perspective
          # The github-runner can resolve "docker" via the runner-network alias
          DIND_IP=$(getent hosts docker | awk '{ print $1 }')

          if [ -z "$DIND_IP" ]; then
            echo "❌ Error: Could not resolve DinD container IP"
            exit 1
          fi

          echo "DinD IP: $DIND_IP"
          echo "Running sdlc-claude container via DinD..."

          docker run --rm \
            --network bridge \
            --add-host=docker:$DIND_IP \
            -e DOCKER_HOST=tcp://docker:2376 \
            -e DOCKER_TLS_VERIFY=1 \
            -e DOCKER_CERT_PATH=/certs/client \
            -v /certs/client:/certs/client:ro \
            -e CLAUDE_CODE_OAUTH_TOKEN="${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" \
            -e GITHUB_TOKEN="$TOKEN" \
            -e GITHUB_REPOSITORY="${{ github.repository }}" \
            -e GITHUB_REF="${{ steps.context.outputs.REF }}" \
            -e CLAUDE_BRANCH_NAME="claude-${{ steps.context.outputs.CLAUDE_TYPE }}-${{ steps.context.outputs.CLAUDE_NUMBER }}" \
            -e USER_PROMPT="$USER_PROMPT" \
            -e GITHUB_ACTOR="${{ steps.context.outputs.ACTOR }}" \
            -e ISSUE_TYPE="${{ steps.context.outputs.TYPE }}" \
            -e ISSUE_NUMBER="${{ steps.context.outputs.NUMBER }}" \
            -e USE_ROUTER="${{ steps.config.outputs.router_enabled }}" \
            -e ROUTER_CONFIG="${{ steps.config.outputs.router_config }}" \
            -e MODEL_OVERRIDE="${{ steps.config.outputs.model_override }}" \
            sdlc-claude:latest
